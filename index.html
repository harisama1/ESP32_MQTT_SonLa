<script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
<script>
// =======================
//  MQTT Connection Setup
// =======================
const broker = 'wss://broker.hivemq.com:8884/mqtt';
const options = {
  clean: true,
  connectTimeout: 4000,
  clientId: 'esp32-web-' + Math.random().toString(16).substr(2, 8),
};
const client = mqtt.connect(broker, options);

client.on('connect', () => {
  console.log('‚úÖ Connected to HiveMQ broker');

  // Subscribe topics for LED states and buttons
  for (let i = 1; i <= 4; i++) {
    client.subscribe(`esp32/led${i}/state`);
    client.subscribe(`esp32/button${i}`);
  }
});

client.on('error', (err) => {
  console.error('‚ùå Connection error: ', err);
});

// =======================
//  Handle incoming MQTT messages
// =======================
client.on('message', (topic, message) => {
  const msg = message.toString();
  console.log('üì© Received:', topic, msg);

  // Update LED state
  if (topic.includes('/led') && topic.includes('/state')) {
    const ledNum = topic.match(/led(\d+)/)[1];
    const status = msg === '1' ? 'ON' : 'OFF';
    const circle = document.getElementById(`led${ledNum}-circle`);
    const label = document.getElementById(`led${ledNum}-status`);

    if (circle && label) {
      circle.style.backgroundColor = status === 'ON' ? 'limegreen' : 'gray';
      label.innerText = status;
    }
  }

  // Update button states
  if (topic.includes('/button')) {
    const btnNum = topic.match(/button(\d+)/)[1];
    const btnLabel = document.getElementById(`button${btnNum}-status`);
    if (btnLabel) {
      btnLabel.innerText = msg;
    }
  }
});

// =======================
//  Control LEDs (Publish)
// =======================
function toggleLED(ledNum) {
  const topic = `esp32/led${ledNum}`;
  client.publish(topic, 'toggle'); // Web sends toggle command
  console.log(`üöÄ Sent toggle command for LED ${ledNum}`);
}

// =======================
//  Debug Connection
// =======================
client.on('reconnect', () => console.log('üîÅ Reconnecting...'));
client.on('close', () => console.log('‚ùå Disconnected from broker'));
</script>
